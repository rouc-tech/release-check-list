# release-check-list
リリース前チェックリスト

本番環境、開発環境、PoC環境、などにリリースする前にチェックする

# 定義:

## フェーズ

| 環境 | 説明 | メモ |
| :---- | :---- | :---- |
| 本番環境 | ユーザに機能を提供している環境 | 基本的にすべてのテストコードがクリアされ、安全に稼動しなければならない。基本的には2環境あり、デプロイ用とプロダクション環境がある。 |
| 開発環境 | 開発中の機能を動かすための環境 | 共同で機能を開発している場合はこの環境で動作確認を行う。基本的には1環境のみだが、ユーザ確認が必要な場合などでは複数の環境が用意されることもある。 |
| PoC環境 | 実験的機能やバグなどを再現するための環境 | 頻繁に破壊され、安定していない。複数環境存在する。 |

## 機能レベル

🌟 重要な機能
🐔⭐ 標準的機能
🌱🐤 実験的機能


TODO 何にするか検討中
🏅
🥈
🥉
🎖


## リリース手順

TODO 絵で説明したいがいい方法がないかなぁ。

### 本番環境

#### (1)通常リリース - 六武衆パターン

普段のリリース方法

2種類のサーバを用意する。

| サーバ | 用途 | サーバ台数 |
| :---- | :---- | :---- |
| Aサーバ | 本番提供中のサーバ | 1台以上(a, b, c,...サーバと名付ける) |
| Bサーバ | デプロイ用のサーバ | 1台(0号機と名付ける) |

Aサーバはクラスタリング環境で提供される可能性がある。1台で本番適用している環境もある。

1. クラスターノードのうち1台(0号機と呼ぶ)の新しいアクセスルートをシャットアウト。セッションの作成を行わないようにする。
1. 0号機の全ユーザセッションが切れるのを待つ(or セッションを別サーバへ転送)
1. 0号機にユーザがいなくなったことを確認する
1. 0号機にリリースしたいソースをデプロイ
1. 0号機が正常にリリースされて稼働していることを確認
1. 0号機にinclusion-list.safe(アクセス許可リスト) or exclusion-list.safe(アクセス除外リスト)を適用する。予め作っておくのがよい。
1. \*-list.safeで定義されたユーザのアクセス履歴やデータベースの値の更新などを確認して、問題なく機能が動作していることを確認
1. \*-list.safeを無効化して、一般ユーザへ開放する
1. ０号機のサーバリソース(メモリ/CPU/NW帯域/ディスク使用量...etc)、セッション数、エラーログ、、、などを約1時間ほど見守る

もしこの時点で以上がある場合、早い段階で0号機をストップして

1. 全ユーザセッションを別サーバへ転送
1. 0号機へ前回のリリースをデプロイ
1. アクセスルート開放

#### (2)切り替えリリース - くず鉄のかかしパターン
1. 
1. 
#### (3)ホットリリース - Sinパターン
1. 
1. 
#### (4)YYYYYYY - XXXXXXX
1. 
1. 
#### (5)YYYYYYY - XXXXXXX
1. 
1. 
#### (6)YYYYYYY - XXXXXXX
1. 
1. 

**それぞれの環境構成のメリデメの整理(忘れないようにメモ)**

TODO 別のmdで書くつもりだが、今のうちに書いておきたかったのでメモ

| 構成名(別名) | サーバ台数 | メリット | デメリット |
| :---- | :---- | :---- | :---- |
| 通常リリース(六武衆パターン) | n台 | サービスを停止しないでデプロイできる。\nデプロイ中に事故っても早い段階で切り戻しが可能。\n | 手順が長い。\nリリース前、リリース後でデータ構造が変わる場合にデータ構成の不整合でエラーが起きるかもしれないので、高度なデータの抽象化を設計時にやらないといけない。 |
| 切り替えリリース(くず鉄のかかしパターン) | 2台 | 通常リリースの台数最小版。\n一瞬にして新しい機能を全ユーザに同時提供できる。 | 大規模サービスの構成では実施不可。\nクライアントアプリから一瞬サーバの所在が消えるので、リトライ設計を忘れると死ねる。 |
| ホットリリース(Sinパターン) | 1台 or n台 | 本番を止めないでバグfixとかが可能。 | Erlang/Elixirなどでしかできない |
| () | x台 |  |  |
| () | x台 |  |  |
| () | x台 |  |  |

\* ... リリース名は著者がてきとーに決めた名前。一般的な名前ではないので注意されたし。

### 開発環境
### PoC環境


## サービスレベル定義

## リリース失敗時のコンティンジェンシープランを用意する

TODO コンティンジェンシープランは必要
TODO リリースバッチとかを用意
TODO ブランチ戦略を記入(ブランチ名とその役割、タグの付け方ルール、など)
TODO 監視方法の記載

